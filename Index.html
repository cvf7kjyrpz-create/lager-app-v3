<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lager App V3</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#05060a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root {
      --bg: #05060a;
      --card: #0d0f18;
      --border: #1f2433;
      --accent: #3ea6ff;
      --text: #f5f7ff;
      --text-soft: #b8bfd9;
      --danger: #ff4b5c;
    }

    body {
      margin: 0;
      padding: 12px;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 900px;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 10px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 14px;
    }

    h2 {
      margin: 0 0 10px;
      font-size: 18px;
    }

    label {
      color: var(--text-soft);
      margin-top: 8px;
      display: block;
      font-size: 13px;
    }

    input, select, textarea {
      width: 100%;
      margin-top: 3px;
      padding: 9px;
      border-radius: 8px;
      background: #080a12;
      border: 1px solid #222a40;
      color: white;
      font-size: 14px;
      box-sizing: border-box;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .btn {
      padding: 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-main {
      background: var(--accent);
      color: black;
    }

    .btn-ghost {
      background: #12141f;
      color: var(--text-soft);
      border: 1px solid #2a3147;
    }

    .btn-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .summary-box {
      flex: 1;
      min-width: 100px;
      background: #101321;
      border: 1px solid #262c44;
      padding: 6px;
      border-radius: 8px;
    }

    .summary-label {
      color: var(--text-soft);
      font-size: 12px;
    }

    .summary-value {
      font-size: 14px;
      font-weight: 600;
    }

    .item-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .item-row {
      background: #090c18;
      border: 1px solid var(--border);
      padding: 7px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .item-row.marked {
      border-color: gold;
      background: rgba(255,215,0,0.1);
    }

    .item-title {
      font-size: 12px;
      font-weight: bold;
    }

    .item-line {
      font-size: 10px;
      color: var(--text-soft);
    }

    .icon-btn {
      width: 26px;
      height: 26px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #2a3147;
      background: #12141f;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn.marked {
      color: gold;
      border-color: gold;
      background: rgba(255,215,0,0.2);
    }

    .icon-btn.danger {
      border-color: var(--danger);
      color: #ffb8c4;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal {
      background: #0d0f18;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
      color: var(--text);
    }

    .modal img {
      max-width: 100%;
      border-radius: 8px;
    }

    .modal-close {
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid #2a3147;
      background: #12141f;
      color: var(--text-soft);
      border-radius: 6px;
    }
  </style>

</head>
<body>
<div class="app">

  <h1>Lager App V3</h1>

  <div class="card">
    <h2>Artikel anlegen</h2>

    <form id="form">
      <input type="hidden" id="id">

      <label>Artikelname *</label>
      <input id="name" required>

      <label>Artikelnummer</label>
      <input id="sku">

      <label>Zustand</label>
      <select id="condition">
        <option value="">Ausw√§hlen‚Ä¶</option>
        <option>Neu</option>
        <option>Gebraucht</option>
      </select>

      <label>Gr√∂√üe</label>
      <input id="size">

      <label>Wo gekauft</label>
      <input id="where">

      <label>Menge *</label>
      <input id="qty" type="number" min="1" value="1">

      <label>Preis pro St√ºck (‚Ç¨)</label>
      <input id="priceUnit" type="number" step="0.01">

      <label>Kaufdatum</label>
      <input id="date" type="date">

      <label>Notiz</label>
      <textarea id="notes"></textarea>

      <label>Foto (optional)</label>
      <input id="photo" type="file" accept="image/*">

      <div class="btn-row">
        <button type="submit" class="btn btn-main">Speichern</button>
        <button type="button" id="reset" class="btn btn-ghost">Leeren</button>
      </div>
    </form>
  </div>

  <div class="card">
    <h2>Lager√ºbersicht</h2>

    <div style="display:flex; gap:10px; margin-bottom:10px;">
      <div class="summary-box">
        <div class="summary-label">Artikel</div>
        <div class="summary-value" id="sumItems">0</div>
      </div>
      <div class="summary-box">
        <div class="summary-label">Menge</div>
        <div class="summary-value" id="sumQty">0</div>
      </div>
      <div class="summary-box">
        <div class="summary-label">Gesamtwert</div>
        <div class="summary-value" id="sumValue">0,00 ‚Ç¨</div>
      </div>
    </div>

    <input id="search" placeholder="Suche‚Ä¶">

    <div id="list" class="item-list"></div>
  </div>

  <div id="modal-backdrop" class="modal-backdrop">
    <div class="modal">
      <button id="modal-close" class="modal-close">Schlie√üen</button>
      <div id="modal-content"></div>
    </div>
  </div>

</div>

<script>
let items = JSON.parse(localStorage.getItem("lager-v3") || "[]");

function save() {
  localStorage.setItem("lager-v3", JSON.stringify(items));
}

function genId() {
  return "i" + Date.now().toString(36);
}

function render() {
  const list = document.getElementById("list");
  const s = document.getElementById("search").value.toLowerCase();

  list.innerHTML = "";

  const sorted = items.slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));

  let sumItems = sorted.length;
  let sumQty = 0;
  let sumValue = 0;

  sorted.filter(i =>
    (i.name||"").toLowerCase().includes(s) ||
    (i.sku||"").toLowerCase().includes(s)
  ).forEach(item => {

    sumQty += item.qty || 0;
    sumValue += item.totalPrice || 0;

    const row = document.createElement("div");
    row.className = "item-row" + (item.flagged ? " marked" : "");

    const main = document.createElement("div");
    main.style.flex = "1";

    main.innerHTML = `
      <div class="item-title">${item.name}</div>
      <div class="item-line">${item.sku ? "Art.-Nr.: "+item.sku : ""}</div>
      <div class="item-line">
        Menge: ${item.qty}
        ¬∑ Stk: ${item.priceUnit?.toFixed(2) || "0.00"} ‚Ç¨
        ¬∑ Gesamt: ${item.totalPrice?.toFixed(2) || "0.00"} ‚Ç¨
      </div>
      <div class="item-line">${item.date ? "Gekauft am "+item.date : ""}</div>
    `;

    const actions = document.createElement("div");
    actions.style.display="flex";
    actions.style.flexDirection="column";
    actions.style.gap="5px";

    function btn(icon, cls, fn) {
      const b = document.createElement("button");
      b.className = "icon-btn " + cls;
      b.textContent = icon;
      b.onclick = fn;
      return b;
    }

    actions.append(
      btn("‚≠ê", item.flagged?"marked":"", ()=>{ item.flagged=!item.flagged; save(); render(); }),
      btn("‚úèÔ∏è","", ()=> fillForm(item)),
      btn("üìù","", ()=> showModal(item.notes || "<i>Keine Notiz</i>")),
      btn("üì∑","", ()=> showModal(item.photo ? `<img src="${item.photo}">` : "<i>Kein Foto</i>")),
      btn("üóëÔ∏è","danger", ()=>{
        if(confirm("L√∂schen?")){
          items = items.filter(x => x.id !== item.id);
          save();
          render();
        }
      })
    );

    row.append(main, actions);
    list.append(row);
  });

  document.getElementById("sumItems").textContent = sumItems;
  document.getElementById("sumQty").textContent = sumQty;
  document.getElementById("sumValue").textContent = sumValue.toFixed(2) + " ‚Ç¨";
}

function fillForm(item) {
  form.id.value = item.id;
  form.name.value = item.name;
  form.sku.value = item.sku;
  form.condition.value = item.condition;
  form.size.value = item.size;
  form.where.value = item.where;
  form.qty.value = item.qty;
  form.priceUnit.value = item.priceUnit;
  form.date.value = item.date;
  form.notes.value = item.notes;
}

async function readPhoto(file) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.readAsDataURL(file);
  });
}

form.onsubmit = async (e) => {
  e.preventDefault();

  const id = form.id.value || genId();
  const idx = items.findIndex(x => x.id === id);
  const old = idx >= 0 ? items[idx] : {};

  let photoData = old.photo || null;
  if (form.photo.files[0]) {
    photoData = await readPhoto(form.photo.files[0]);
  }

  const qty = parseInt(form.qty.value) || 1;
  const priceUnit = parseFloat(form.priceUnit.value) || 0;
  const totalPrice = qty * priceUnit;

  const item = {
    id,
    name: form.name.value.trim(),
    sku: form.sku.value.trim(),
    condition: form.condition.value,
    size: form.size.value.trim(),
    where: form.where.value.trim(),
    qty,
    priceUnit,
    totalPrice,
    date: form.date.value,
    notes: form.notes.value.trim(),
    flagged: old.flagged || false,
    photo: photoData
  };

  if (idx >= 0) items[idx] = item;
  else items.push(item);

  save();
  form.reset();
  render();
};

document.getElementById("reset").onclick = () => form.reset();
document.getElementById("search").oninput = render;

function showModal(html) {
  document.getElementById("modal-content").innerHTML = html;
  document.getElementById("modal-backdrop").style.display = "flex";
}

document.getElementById("modal-close").onclick = () =>
  document.getElementById("modal-backdrop").style.display = "none";

render();

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
